// @flow

import type {Dispatch, MiddlewareAPI, Store, Reducer, Middleware, ActionCreator} from 'redux'

/*

 S = State
 A = Action

 */

export type ActionCreators<K, A> = { [key: K]: ActionCreator<A> }

export type CreateReducer<S, A> =
  (<S, A: {type: $Subtype<string>}>(reducers: {[actionType: string]: Reducer<S, A>}) => Reducer<S, A>) |
  (<S, A: {type: $Subtype<string>}>(initialState: S, reducers: {[actionType: string]: Reducer<S, A>}) => Reducer<S, A>)
export type ComposeReducers<S, A> = (...reducers: Array<Reducer<S, A>>) => Reducer<S, A>
export type ComposeMiddleware<S, A> = (...middlewares: Array<Middleware<S, A>>) => Middleware<S, A>

export type FeatureState = 'NOT_LOADED' | 'LOADING' | 'LOADED' | Error
export type FeatureStates = {[featureId: string]: FeatureState}

export type Feature<S, A> = {
  init?: (store: MiddlewareAPI<S, A>) => any,
  load?: (store: MiddlewareAPI<S, A>) => Promise<Feature<S, A>>,
  dependencies?: Array<string>,
  middleware?: Middleware<S, A>,
  reducer?: Reducer<S, A>,
}
export type Features<S, A> = {[featureId: string]: Feature<S, A>}

declare export var ACTION_TYPE_PREFIX: string
declare export var ADD_FEATURE: string
declare export var LOAD_FEATURE: string
declare export var INSTALL_FEATURE: string
declare export var REPLACE_FEATURE: string
declare export var SET_FEATURE_STATUS: string

export type FeatureAction = {
  type: string,
  payload?: any,
  meta?: {id: string},
}

declare export function addFeature<S, A>(id: string, feature: Feature<S, A>): FeatureAction
declare export function replaceFeature<S, A>(id: string, feature: Feature<S, A>): FeatureAction
declare export function loadFeature(id: string): FeatureAction
declare export function installFeature<S, A>(id: string, feature: Feature<S, A>): FeatureAction
declare export function setFeatureState(id: string, payload: FeatureState): FeatureAction
declare export function loadInitialFeatures(): FeatureAction

declare export function featuresReducer<S, A>(
  config?: {createReducer?: CreateReducer<Features<S, A>, FeatureAction>}
): Reducer<Features<S, A>, FeatureAction>

declare export function featureStatesReducer<S>(
  config?: {createReducer?: CreateReducer<FeatureStates, FeatureAction>}
): Reducer<FeatureStates, FeatureAction>

declare export function featureReducersReducer<S, A>(
  config?: {
    getFeatures?: (state: S) => ?Features<S, A>,
    composeReducers?: ComposeReducers<S, A>,
  }
): Reducer<S, A>

declare export function loadFeatureMiddleware<S, A: {+type?: string, +payload?: Feature<any, any>, +meta?: Object}>(
  config?: {
    getFeatures?: (state: S) => ?Features<S, A>,
    getFeatureStates?: (state: S) => ?FeatureStates,
  }
): Middleware<S, A>

declare export function featureMiddlewaresMiddleware<S, A>(
  config?: {
    getFeatures?: (state: S) => ?Features<S, A>,
    composeMiddleware?: ComposeMiddleware<S, A>,
  }
): Middleware<S, A>

declare export function composeReducers<S, A>(...reducers: Array<Reducer<S, A>>): Reducer<S, A>